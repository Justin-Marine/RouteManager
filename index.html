<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Route Manager V1.3 Integrated</title>
    
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    
    <style>
        /* === 1. Base Reset === */
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; background-color: #f2f2f7; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        /* === 2. Layout & Map === */
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }

        /* === 3. Top UI Bar === */
        #top-bar {
            position: absolute; top: 12px; left: 12px; right: 12px;
            display: flex; justify-content: space-between; align-items: flex-start;
            z-index: 20; pointer-events: none; /* Î∞∞Í≤ΩÏùÄ ÌÅ¥Î¶≠ Ìà¨Í≥º */
        }

        /* Status Panel */
        #status-panel {
            background: rgba(255, 255, 255, 0.95); padding: 12px 16px; border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12); font-size: 13px; width: 230px;
            pointer-events: auto; /* Ìå®ÎÑêÏùÄ ÌÅ¥Î¶≠ Í∞ÄÎä• */ backdrop-filter: blur(10px);
        }
        .status-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .label { color: #666; font-weight: 500; }
        .val { font-weight: 700; color: #007aff; }
        .legend-row { margin-top: 8px; font-size: 11px; display: flex; gap: 8px; font-weight: bold; }

        /* Right Top Buttons */
        .right-group { display: flex; flex-direction: column; gap: 10px; pointer-events: auto; }
        .icon-btn {
            background: white; border: none; border-radius: 14px;
            width: 44px; height: 44px; font-size: 22px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.1s; pointer-events: auto; /* Î≤ÑÌäº ÌÅ¥Î¶≠ ÌïÑÏàò */
        }
        .icon-btn:active { transform: scale(0.95); background: #f2f2f2; }

        /* === 4. Layer Popover === */
        #layer-popover {
            display: none; position: absolute; top: 70px; right: 70px; width: 220px;
            background: rgba(255, 255, 255, 0.98); border-radius: 16px; padding: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15); z-index: 30; pointer-events: auto;
            max-height: 300px; overflow-y: auto;
        }
        #layer-popover.visible { display: block; animation: fadeIn 0.2s; }
        .layer-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 0; border-bottom: 1px solid #eee; font-size: 14px;
        }

        /* === 5. Bottom UI & Floating Buttons === */
        #fab-container {
            position: absolute; bottom: 100px; right: 12px;
            display: flex; flex-direction: column; align-items: flex-end; gap: 15px;
            z-index: 20; pointer-events: none;
        }

        /* Sub Menu (Hidden by default) */
        .event-sub-group {
            display: flex; flex-direction: column; gap: 12px; align-items: flex-end;
            margin-bottom: 5px; opacity: 0; transform: translateY(20px); pointer-events: none;
            transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .event-sub-group.open { opacity: 1; transform: translateY(0); pointer-events: auto; }

        .fab-wrapper { position: relative; display: flex; align-items: center; pointer-events: auto; }
        .sub-btn {
            width: 44px; height: 44px; border-radius: 22px; border: none;
            background: white; color: #333; font-size: 20px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .sub-btn-label {
            position: absolute; right: 55px; background: rgba(0,0,0,0.7); color: white;
            padding: 4px 8px; border-radius: 6px; font-size: 12px; white-space: nowrap;
            opacity: 0; transition: opacity 0.2s; pointer-events: none;
        }
        .sub-btn:active .sub-btn-label { opacity: 1; }

        /* Main Event Toggle Button */
        #btn-event-toggle {
            background: #ff9500; color: white; font-size: 26px;
            border-radius: 50%; width: 60px; height: 60px; border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); pointer-events: auto; cursor: pointer;
            transition: transform 0.2s; display: flex; align-items: center; justify-content: center;
        }
        #btn-event-toggle.active { transform: rotate(45deg); background: #ff3b30; }

        /* My Location Button */
        #btn-my-loc {
            width: 60px; height: 60px; border-radius: 50%; font-size: 26px;
            background: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            pointer-events: auto; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* Bottom Survey Button */
        #bottom-bar {
            position: absolute; bottom: 20px; left: 12px; right: 12px;
            z-index: 20; pointer-events: none;
        }
        .main-action-btn {
            width: 100%; height: 60px; border: none; border-radius: 20px;
            font-weight: 800; color: white; font-size: 18px;
            background-color: #8e8e93; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer; pointer-events: auto; transition: background 0.3s;
        }
        .main-action-btn.active { background-color: #34c759; }

        /* === 6. Settings Panel === */
        #settings-view {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: #f2f2f7; z-index: 50; display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        #settings-view.active { transform: translateX(0); }

        .header { background: white; padding: 16px; display: flex; align-items: center; border-bottom: 1px solid #e5e5ea; }
        .title { font-weight: 800; font-size: 20px; margin-left: 12px; }
        .tabs { display: flex; background: white; padding: 0 16px; }
        .tab { flex: 1; padding: 14px; border: none; background: none; font-weight: 600; color: #8e8e93; border-bottom: 3px solid transparent; cursor: pointer; }
        .tab.active { color: #007aff; border-bottom: 3px solid #007aff; }
        .content { flex: 1; overflow-y: auto; padding: 16px; pointer-events: auto; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        
        .card { background: white; border-radius: 14px; padding: 16px; margin-bottom: 20px; }
        .field { margin-bottom: 16px; }
        .field label { display: block; font-size: 14px; margin-bottom: 6px; font-weight: 600; color: #333; }
        .field input, .field select { width: 100%; padding: 12px; border: 1px solid #d1d1d6; border-radius: 10px; font-size: 16px; background: #fff; }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; margin-top: 8px; }
        .btn-primary { background: #007aff; color: white; }
        .btn-secondary { background: #e5e5ea; color: black; }
        .btn-danger { background: #ff3b30; color: white; }

        .layer-manage-item { background: #f9f9f9; padding: 12px; border-radius: 10px; margin-bottom: 8px; display: flex; flex-direction: column; gap: 8px; border: 1px solid #eee; }
        .layer-header { display: flex; justify-content: space-between; align-items: center; }
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; font-weight: bold; }
        .tag.target { background: #34c759; color: white; }

        /* === 7. Camera Overlay === */
        #camera-overlay {
            display: none; position: absolute; top:0; left:0; right:0; bottom:0;
            background: black; z-index: 100; align-items: center; justify-content: center; flex-direction: column;
        }
        #camera-overlay.active { display: flex; }
        #camera-view { width: 100%; height: 100%; object-fit: cover; }
        #camera-ui { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; gap: 30px; z-index: 101; pointer-events: auto; }
        .shutter-btn { width: 72px; height: 72px; border-radius: 50%; background: white; border: 5px solid #ccc; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="main-ui">
    <div id="top-bar">
        <div id="status-panel">
            <div class="status-row"><span class="label">Status</span> <span id="st-mode" class="val">Inactive</span></div>
            <div class="status-row"><span class="label">GPS</span> <span id="st-gps" class="val">-</span></div>
            <div class="status-row"><span class="label">Target</span> <span id="st-match" class="val">-</span></div>
            <div class="legend-row">
                <span style="color:#ff3b30">‚óè 3</span> <span style="color:#ffcc00">‚óè 2</span> <span style="color:#34c759">‚óè 1</span> <span style="color:#d1d1d6">‚óè 0</span>
            </div>
        </div>
        <div class="right-group">
            <button class="icon-btn" onclick="App.UI.openSettings()">‚öôÔ∏è</button>
            <button class="icon-btn" onclick="App.UI.toggleLayerPopover()">üó∫Ô∏è</button>
        </div>
    </div>
    
    <div id="layer-popover"><div id="popover-list"></div></div>
    
    <div id="map"></div>

    <div id="fab-container">
        <div id="event-sub-menu" class="event-sub-group">
            <div class="fab-wrapper"><span class="sub-btn-label">Ïπ¥Î©îÎùº</span><button class="sub-btn" onclick="App.Event.startCamera()">üì∑</button></div>
            <div class="fab-wrapper"><span class="sub-btn-label">Í≥µÏÇ¨Ï§ë</span><button class="sub-btn" onclick="App.Event.sendText('Í≥µÏÇ¨Ï§ë')">üöß</button></div>
            <div class="fab-wrapper"><span class="sub-btn-label">Ï†ïÏ≤¥</span><button class="sub-btn" onclick="App.Event.sendText('Ï†ïÏ≤¥')">üöó</button></div>
            <div class="fab-wrapper"><span class="sub-btn-label">Í∏∞ÌÉÄ</span><button class="sub-btn" onclick="App.Event.sendText('Í∏∞ÌÉÄ')">üìù</button></div>
        </div>
        
        <button id="btn-event-toggle" onclick="App.Event.toggleMenu()">‚ö°</button>
        
        <button id="btn-my-loc" onclick="App.Map.centerUser()">üéØ</button>
    </div>

    <div id="bottom-bar">
        <button id="btn-survey" class="main-action-btn" onclick="App.Engine.toggleSurvey()">Start Survey</button>
    </div>
</div>

<div id="settings-view">
    <div class="header">
        <button class="icon-btn" style="box-shadow:none; width:40px; height:40px;" onclick="App.UI.closeSettings()">‚ùÆ</button>
        <span class="title">ÏÑ§Ï†ï (Settings)</span>
    </div>
    <div class="tabs">
        <button class="tab active" onclick="App.UI.switchTab('tab-layers')">Îç∞Ïù¥ÌÑ∞</button>
        <button class="tab" onclick="App.UI.switchTab('tab-algo')">ÏïåÍ≥†Î¶¨Ï¶ò</button>
        <button class="tab" onclick="App.UI.switchTab('tab-system')">ÏãúÏä§ÌÖú</button>
    </div>
    <div class="content">
        <div id="tab-layers" class="tab-pane active">
            <div class="card">
                <h3>Î†àÏù¥Ïñ¥ Ï∂îÍ∞Ä</h3>
                <div class="field">
                    <select id="add-type" onchange="App.UI.toggleAddForm()">
                        <option value="geojson_file">Î°úÏª¨ GeoJSON ÌååÏùº</option>
                        <option value="geojson_url">Ïõπ GeoJSON URL</option>
                        <option value="raster">Î∞∞Í≤ΩÏßÄÎèÑ URL (XYZ)</option>
                    </select>
                </div>
                <div id="form-url" class="field">
                    <input type="text" id="add-url" placeholder="URL ÏûÖÎ†•...">
                    <input type="file" id="add-file" accept=".geojson,.json" style="display:none">
                    <button id="btn-file-sel" class="btn btn-secondary" onclick="document.getElementById('add-file').click()">üìÇ ÌååÏùº ÏÑ†ÌÉù</button>
                </div>
                <div class="field"><input type="text" id="add-name" placeholder="Î†àÏù¥Ïñ¥ Ïù¥Î¶Ñ"></div>
                <button class="btn btn-primary" onclick="App.Layers.addNewLayerFromUI()">Ï∂îÍ∞ÄÌïòÍ∏∞</button>
            </div>
            <div class="card"><h3>Î†àÏù¥Ïñ¥ Í¥ÄÎ¶¨</h3><div id="manage-list"></div></div>
        </div>
        <div id="tab-algo" class="tab-pane">
            <div class="card">
                <h3>Îß§Ïπ≠ ÏÑ§Ï†ï</h3>
                <div class="field"><label>Ïö¥ÏòÅ Î™®Îìú</label><select id="cfg-mode"><option value="dec">Í∞êÏÜå</option><option value="inc">Ï¶ùÍ∞Ä</option></select></div>
                <div class="field"><label>Î≥¥Í∞Ñ Í∞ÑÍ≤©(m)</label><input type="number" id="cfg-interp" step="0.05"></div>
                <div class="field"><label>ÌÉêÏÉâ Î∞òÍ≤Ω(m)</label><input type="number" id="cfg-dist"></div>
                <div class="field"><label>Overlap (0.1~1.0)</label><input type="number" id="cfg-overlap" step="0.05" max="1.0"></div>
                <div class="field"><label>ÏÜçÏÑ± ÌïÑÎìúÎ™Ö</label><input type="text" id="cfg-field"></div>
                <div class="field"><label>Í∏∞Î≥∏Í∞í</label><input type="number" id="cfg-defval"></div>
                <button class="btn btn-primary" onclick="App.Config.saveFromUI()">Ï†ÄÏû•ÌïòÍ∏∞</button>
            </div>
        </div>
        <div id="tab-system" class="tab-pane">
            <div class="card">
                <h3>ÏÑ§Ï†ï ÌååÏùº</h3>
                <button class="btn btn-secondary" onclick="App.Config.exportSettings()">ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (.json)</button>
                <input type="file" id="import-file" accept=".json" style="display:none" onchange="App.Config.importSettings(this)">
                <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">Î∂àÎü¨Ïò§Í∏∞</button>
            </div>
            <div class="card">
                <h3>ÌÜµÏã†</h3>
                <div class="field"><label>WebSocket URL</label><input type="text" id="cfg-ws"></div>
                <button id="btn-ws" class="btn btn-secondary" onclick="App.Engine.toggleWS()">Ïó∞Í≤∞</button>
            </div>
            <div class="card"><button class="btn btn-danger" onclick="App.Config.clearAll()">Ïï± Ï¥àÍ∏∞Ìôî</button></div>
        </div>
    </div>
</div>

<div id="camera-overlay">
    <video id="camera-view" playsinline autoplay muted></video>
    <canvas id="camera-canvas" style="display:none;"></canvas>
    <div id="camera-ui">
        <button class="btn btn-secondary" style="width:100px; color:black; background:white;" onclick="App.Event.closeCamera()">Ï∑®ÏÜå</button>
        <button class="shutter-btn" onclick="App.Event.captureAndSend()"></button>
        <div style="width:100px;"></div>
    </div>
</div>

<script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
<script src='https://unpkg.com/@turf/turf@6.5.0/turf.min.js'></script>

<script>
/**
 * Route Manager V1.3 Integrated Logic
 */
const App = {
    // 1. Config & Persistence
    Config: {
        data: {
            interpStep: 0.25, searchRadius: 12.5, overlapRatio: 0.9, bufferRadius: 1.0,
            mode: 'dec', targetField: 'target_cnt', defaultValue: 1, wsUrl: 'wss://echo.websocket.org'
        },
        init() {
            const saved = localStorage.getItem('RM_Config_V3');
            if (saved) this.data = { ...this.data, ...JSON.parse(saved) };
        },
        save() { localStorage.setItem('RM_Config_V3', JSON.stringify(this.data)); },
        saveFromUI() {
            this.data.interpStep = parseFloat(document.getElementById('cfg-interp').value);
            this.data.searchRadius = parseFloat(document.getElementById('cfg-dist').value);
            this.data.overlapRatio = parseFloat(document.getElementById('cfg-overlap').value);
            this.data.mode = document.getElementById('cfg-mode').value;
            this.data.targetField = document.getElementById('cfg-field').value;
            this.data.defaultValue = parseInt(document.getElementById('cfg-defval').value);
            this.data.wsUrl = document.getElementById('cfg-ws').value;
            this.save();
            if (App.Layers.targetId) App.Layers.applyTargetStyle(App.Layers.targetId);
            alert("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
            App.UI.closeSettings();
        },
        exportSettings() {
            const packet = { config: this.data, layers: App.Layers.list.map(l => { const {data, ...meta} = l; return meta; }) };
            const blob = new Blob([JSON.stringify(packet, null, 2)], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `rm_config_${Date.now()}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        },
        importSettings(input) {
            const file = input.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    const packet = JSON.parse(e.target.result);
                    if(packet.config) this.data = packet.config;
                    if(packet.layers) { App.Layers.list = []; packet.layers.forEach(l => App.Layers.addLayer(l)); }
                    this.save(); App.Layers.save();
                    alert("ÏÑ§Ï†ïÏù¥ Î°úÎìúÎêòÏóàÏäµÎãàÎã§. Ïï±ÏùÑ ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§."); location.reload();
                } catch(err) { alert("ÌååÏùº Ïò§Î•ò"); }
            };
            r.readAsText(file);
        },
        clearAll() { if(confirm("Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) { localStorage.clear(); location.reload(); } }
    },

    // 2. Global State
    State: { isSurveying: false, lastGps: null, currentMatchId: null, wsConnected: false, traceMemory: {}, visitHistory: {}, gpsLog: [] },

    // 3. Layer Manager
    Layers: {
        list: [], targetId: null,
        init() {
            const saved = localStorage.getItem('RM_Layers_V3');
            if (saved) this.list = JSON.parse(saved);
            else this.addLayer({ id: 'osm-base', type: 'raster', name: 'OpenStreetMap', visible: true, url: 'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png' });
        },
        save() {
            const toSave = this.list.map(l => { const { data, ...meta } = l; return meta; });
            localStorage.setItem('RM_Layers_V3', JSON.stringify(toSave));
        },
        addLayer(l) { if(!this.list.find(x => x.id === l.id)) this.list.push(l); this.addToMap(l); this.save(); App.UI.renderLayerLists(); },
        removeLayer(id) {
            if (id === 'osm-base') return;
            if (App.Map.instance.getLayer(id)) App.Map.instance.removeLayer(id);
            if (App.Map.instance.getSource(id)) App.Map.instance.removeSource(id);
            if (this.targetId === id) { if (App.Map.instance.getLayer('target-viz')) App.Map.instance.removeLayer('target-viz'); this.targetId = null; }
            this.list = this.list.filter(l => l.id !== id);
            this.save(); App.UI.renderLayerLists();
        },
        setTarget(id) {
            const layer = this.list.find(l => l.id === id);
            if (!layer || layer.type !== 'geojson') return;
            this.list.forEach(l => l.isTarget = false); layer.isTarget = true; this.targetId = id;
            if (layer.data) { this.ensureFields(layer.data); App.Map.instance.getSource(id).setData(layer.data); }
            this.applyTargetStyle(id); this.save(); App.UI.renderLayerLists();
        },
        ensureFields(geojson) {
            const field = App.Config.data.targetField;
            const def = App.Config.data.defaultValue;
            geojson.features.forEach(f => { if (f.properties[field] === undefined) f.properties[field] = def; });
        },
        addToMap(l) {
            const map = App.Map.instance;
            if (map.getSource(l.id)) return;
            if (l.type === 'raster') {
                map.addSource(l.id, { type: 'raster', tiles: [l.url], tileSize: 256 });
                map.addLayer({ id: l.id, type: 'raster', source: l.id, layout: { visibility: l.visible ? 'visible' : 'none' } }, 'target-bg');
            } else if (l.type === 'geojson') {
                if (!l.data && l.url) { fetch(l.url).then(r => r.json()).then(json => { l.data = json; this.addToMap(l); }); return; }
                if (!l.data) return;
                map.addSource(l.id, { type: 'geojson', data: l.data });
                map.addLayer({ id: l.id, type: 'line', source: l.id, layout: { 'line-cap': 'round', 'line-join': 'round', visibility: l.visible ? 'visible' : 'none' }, paint: { 'line-width': 6, 'line-color': '#888', 'line-opacity': 0.4 } });
                if (l.isTarget) { this.targetId = l.id; this.ensureFields(l.data); this.applyTargetStyle(l.id); }
            }
        },
        applyTargetStyle(sourceId) {
            const map = App.Map.instance;
            if (map.getLayer('target-viz')) map.removeLayer('target-viz');
            const field = App.Config.data.targetField;
            map.addLayer({
                id: 'target-viz', type: 'line', source: sourceId,
                layout: { 'line-cap': 'round', 'line-join': 'round' },
                paint: {
                    'line-width': 5,
                    'line-color': ['match', ['get', field], 1, '#34c759', 2, '#ffcc00', 3, '#ff3b30', '#007aff'],
                    'line-opacity': ['case', ['>', ['get', field], 0], 0.6, 0.0]
                }
            });
        },
        addNewLayerFromUI() {
            const type = document.getElementById('add-type').value;
            const name = document.getElementById('add-name').value;
            if (!name) return alert("Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî");
            const newId = 'L' + Date.now();
            let obj = { id: newId, name: name, visible: true, isTarget: false };
            if (type === 'geojson_file') {
                const f = document.getElementById('add-file').files[0];
                if (!f) return alert("ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî");
                const r = new FileReader();
                r.onload = e => {
                    obj.type = 'geojson'; obj.data = JSON.parse(e.target.result);
                    this.addLayer(obj);
                    const bbox = turf.bbox(obj.data);
                    App.Map.instance.fitBounds(bbox, {padding:50});
                    if(!this.targetId) this.setTarget(newId);
                };
                r.readAsText(f);
            } else {
                obj.url = document.getElementById('add-url').value;
                obj.type = (type === 'raster') ? 'raster' : 'geojson';
                this.addLayer(obj);
            }
        },
        toggleVis(id, v) {
            const l = this.list.find(x=>x.id===id); if(l) l.visible = v;
            if(App.Map.instance.getLayer(id)) App.Map.instance.setLayoutProperty(id, 'visibility', v?'visible':'none');
            if(id===this.targetId && App.Map.instance.getLayer('target-viz')) App.Map.instance.setLayoutProperty('target-viz', 'visibility', v?'visible':'none');
            this.save();
        }
    },

    // 4. Map
    Map: {
        instance: null,
        init() {
            this.instance = new maplibregl.Map({
                container: 'map',
                style: { version: 8, sources: {}, layers: [] },
                center: [126.9778, 37.5663], zoom: 17
            });
            this.instance.on('load', () => {
                this.instance.addSource('user_pos', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
                this.instance.addLayer({ id: 'user-marker', type: 'circle', source: 'user_pos', paint: { 'circle-radius': 8, 'circle-color': '#8e8e93', 'circle-stroke-width': 2, 'circle-stroke-color': '#fff' } });
                App.Layers.init();
                App.Layers.list.forEach(l => App.Layers.addToMap(l));
                App.Engine.startGps();
                this.centerUser();
            });
        },
        updateMarker(pt, active) {
            this.instance.setPaintProperty('user-marker', 'circle-color', active ? '#34c759' : '#8e8e93');
            this.instance.getSource('user_pos').setData({ type: 'FeatureCollection', features: [{ type: 'Feature', geometry: { type: 'Point', coordinates: pt } }] });
        },
        centerUser() {
            navigator.geolocation.getCurrentPosition(
                p => App.Map.instance.flyTo({ center: [p.coords.longitude, p.coords.latitude], zoom: 18 }),
                e => console.log("GPS Init Fail")
            );
        }
    },

    // 5. Engine
    Engine: {
        wsSocket: null,
        startGps() {
            if (!navigator.geolocation) return;
            navigator.geolocation.watchPosition(pos => {
                const { longitude, latitude, accuracy, speed, heading } = pos.coords;
                App.State.lastGps = { lng: longitude, lat: latitude, speed: speed||0, heading: heading||0 };
                document.getElementById('st-gps').innerText = `¬±${Math.round(accuracy)}m`;
                App.Map.updateMarker([longitude, latitude], App.State.isSurveying);
                if (App.State.isSurveying) this.processMatching([longitude, latitude]);
            }, e => console.error(e), { enableHighAccuracy: true });
            setInterval(() => this.sendWs(), 1000);
        },
        toggleSurvey() {
            App.State.isSurveying = !App.State.isSurveying;
            App.UI.updateSurveyBtn();
        },
        processMatching(pt) {
            const layerId = App.Layers.targetId;
            if (!layerId) return;
            const layer = App.Layers.list.find(l => l.id === layerId);
            if (!layer || !layer.data) return;
            const cfg = App.Config.data;
            const ptGeo = turf.point(pt);
            let bestId = null, minDist = Infinity;
            layer.data.features.forEach(f => {
                const snapped = turf.nearestPointOnLine(f, ptGeo);
                const dist = turf.distance(ptGeo, snapped, {units: 'kilometers'}) * 1000;
                if (dist < cfg.searchRadius && dist < minDist) { minDist = dist; bestId = f.properties.id || f.id; }
            });
            App.State.currentMatchId = bestId; 
            document.getElementById('st-match').innerText = bestId ? `ID: ${bestId}` : "-";
            if (bestId) this.updateTrace(layerId, bestId, pt);
        },
        updateTrace(layerId, linkId, pt) {
            const key = `${layerId}-${linkId}`;
            if (!App.State.traceMemory[key]) App.State.traceMemory[key] = [];
            const mem = App.State.traceMemory[key];
            if (mem.length > 200) mem.shift();
            mem.push(pt);
            if (mem.length < 2) return;
            try {
                const cfg = App.Config.data;
                const line = turf.lineString(mem);
                const tBuf = turf.buffer(turf.simplify(line, {tolerance:0.00001}), cfg.bufferRadius/1000, {units:'kilometers'});
                const layer = App.Layers.list.find(l => l.id === layerId);
                const lFeat = layer.data.features.find(f => (f.properties.id == linkId || f.id == linkId));
                const lBuf = turf.buffer(lFeat, cfg.bufferRadius/1000, {units:'kilometers'});
                if (turf.area(turf.intersect(tBuf, lBuf)) / turf.area(lBuf) >= cfg.overlapRatio) this.handlePass(layer, lFeat);
            } catch(e) {}
        },
        handlePass(layer, feature) {
            const key = `${layer.id}-${feature.properties.id}`;
            const now = Date.now();
            if (App.State.visitHistory[key] && (now - App.State.visitHistory[key]) < 5000) return;
            App.State.visitHistory[key] = now;
            const cfg = App.Config.data;
            let val = feature.properties[cfg.targetField] || 0;
            if (cfg.mode === 'dec') { val--; if(val<0) val=0; } else val++;
            feature.properties[cfg.targetField] = val;
            App.Map.instance.getSource(layer.id).setData(layer.data);
        },
        toggleWS() {
            if (App.State.wsConnected) { App.State.wsSocket.close(); App.State.wsConnected = false; }
            else {
                try {
                    App.State.wsSocket = new WebSocket(App.Config.data.wsUrl);
                    App.State.wsSocket.onopen = () => { App.State.wsConnected = true; alert("WS Connected"); };
                    App.State.wsSocket.onclose = () => { App.State.wsConnected = false; };
                } catch(e) { alert("WS Fail"); }
            }
            App.UI.updateWsBtn();
        },
        sendWs() {
            if (App.State.wsConnected && App.State.lastGps) {
                const pl = { ...App.State.lastGps, surveying: App.State.isSurveying, matched_link_id: App.State.currentMatchId, ts: Date.now() };
                App.State.wsSocket.send(JSON.stringify(pl));
            }
        },
        sendEventPayload(type, data) {
            if (App.State.wsConnected && App.State.lastGps) {
                const pl = { type: 'event', eventType: type, eventData: data, loc: App.State.lastGps, linkId: App.State.currentMatchId, ts: Date.now() };
                App.State.wsSocket.send(JSON.stringify(pl));
                alert("Ïù¥Î≤§Ìä∏ Ï†ÑÏÜ°Îê®");
            } else alert("ÏÑúÎ≤Ñ ÎØ∏Ïó∞Í≤∞");
        }
    },

    // 6. UI & Event
    Event: {
        videoStream: null,
        toggleMenu() {
            document.getElementById('event-sub-menu').classList.toggle('open');
            document.getElementById('btn-event-toggle').classList.toggle('active');
        },
        sendText(txt) { App.Engine.sendEventPayload('text', txt); this.toggleMenu(); },
        async startCamera() {
            this.toggleMenu();
            const video = document.getElementById('camera-view');
            document.getElementById('camera-overlay').classList.add('active');
            try {
                this.videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
                video.srcObject = this.videoStream;
            } catch(e) { alert("Ïπ¥Î©îÎùº Í∂åÌïú Ïò§Î•ò"); App.Event.closeCamera(); }
        },
        captureAndSend() {
            const video = document.getElementById('camera-view');
            const canvas = document.getElementById('camera-canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const base64 = canvas.toDataURL('image/jpeg', 0.6);
            App.Engine.sendEventPayload('image', base64);
            this.closeCamera();
        },
        closeCamera() {
            if(this.videoStream) this.videoStream.getTracks().forEach(t=>t.stop());
            document.getElementById('camera-overlay').classList.remove('active');
        }
    },

    UI: {
        openSettings() { 
            document.getElementById('settings-view').classList.add('active');
            const d = App.Config.data;
            document.getElementById('cfg-interp').value = d.interpStep;
            document.getElementById('cfg-dist').value = d.searchRadius;
            document.getElementById('cfg-overlap').value = d.overlapRatio;
            document.getElementById('cfg-mode').value = d.mode;
            document.getElementById('cfg-field').value = d.targetField;
            document.getElementById('cfg-defval').value = d.defaultValue;
            document.getElementById('cfg-ws').value = d.wsUrl;
        },
        closeSettings() { document.getElementById('settings-view').classList.remove('active'); },
        switchTab(id) {
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active'); document.getElementById(id).classList.add('active');
        },
        toggleLayerPopover() {
            const el = document.getElementById('layer-popover');
            el.classList.toggle('visible');
            this.renderLayerLists();
        },
        toggleAddForm() {
            const t = document.getElementById('add-type').value;
            const f = document.getElementById('form-url');
            if(t.includes('file')) f.innerHTML = '<input type="file" id="add-file" accept=".geojson,.json" class="btn btn-secondary">';
            else f.innerHTML = '<input type="text" id="add-url" placeholder="URL ÏûÖÎ†•...">';
        },
        updateSurveyBtn() {
            const b = document.getElementById('btn-survey');
            const s = document.getElementById('st-mode');
            if(App.State.isSurveying) { b.innerText="Stop Survey"; b.classList.add('active'); s.innerText="Active"; s.classList.add('active'); }
            else { b.innerText="Start Survey"; b.classList.remove('active'); s.innerText="Inactive"; s.classList.remove('active'); }
        },
        updateWsBtn() {
            const b = document.getElementById('btn-ws');
            if(App.State.wsConnected) { b.innerText="Ïó∞Í≤∞ Ï¢ÖÎ£å"; b.classList.replace('btn-secondary','btn-primary'); }
            else { b.innerText="Ïó∞Í≤∞ ÏãúÏûë"; b.classList.replace('btn-primary','btn-secondary'); }
        },
        renderLayerLists() {
            const mList = document.getElementById('manage-list'); mList.innerHTML = '';
            App.Layers.list.forEach(l => {
                if(l.id==='osm-base') return;
                const isT = l.id === App.Layers.targetId;
                mList.innerHTML += `<div class="layer-manage-item"><div class="layer-header"><span style="font-weight:600;">${l.name}</span><div>${isT?'<span class="tag target">TARGET</span>':''}<span class="tag">${l.type}</span></div></div><div style="display:flex; gap:5px;">${l.type==='geojson'?`<button class="btn btn-primary" style="margin:0; padding:8px; font-size:12px; flex:2;" onclick="App.Layers.setTarget('${l.id}')">Target</button>`:''}<button class="btn btn-danger" style="margin:0; padding:8px; font-size:12px; flex:1;" onclick="App.Layers.removeLayer('${l.id}')">ÏÇ≠Ï†ú</button></div></div>`;
            });
            const pList = document.getElementById('popover-list'); pList.innerHTML = '';
            App.Layers.list.forEach(l => {
                pList.innerHTML += `<div class="layer-row"><span class="layer-label">${l.name}${l.id===App.Layers.targetId?' (T)':''}</span><input type="checkbox" ${l.visible?'checked':''} onchange="App.Layers.toggleVis('${l.id}', this.checked)"></div>`;
            });
        },
        toggleVis(id, v) { App.Layers.toggleVis(id, v); }
    }
};

// Safe Init
document.addEventListener('DOMContentLoaded', () => {
    App.Config.init();
    App.Map.init();
});
</script>
</body>
</html>