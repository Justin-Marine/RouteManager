<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Route Manager V1</title>
    
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    
    <style>
        /* === Base Styles === */
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; background-color: #f2f2f7; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* === Layout === */
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        
        /* Top Bar */
        #top-bar {
            position: absolute; top: 12px; left: 12px; right: 12px;
            display: flex; justify-content: space-between; align-items: flex-start;
            z-index: 10; pointer-events: none;
        }
        
        /* Status Panel */
        #status-panel {
            background: rgba(255, 255, 255, 0.95); padding: 12px 16px; border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12); font-size: 13px; width: 240px;
            pointer-events: auto; backdrop-filter: blur(10px);
        }
        .status-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .status-row:last-child { margin-bottom: 0; }
        .label { color: #666; font-weight: 500; }
        .val { font-weight: 700; color: #007aff; }
        .val.active { color: #34c759; }
        
        /* Right Buttons */
        .right-group { display: flex; flex-direction: column; gap: 10px; pointer-events: auto; }
        .icon-btn {
            background: white; border: none; border-radius: 14px;
            width: 48px; height: 48px; font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.1s;
        }
        .icon-btn:active { transform: scale(0.95); background: #f2f2f2; }

        /* Layer Popover */
        #layer-popover {
            display: none; position: absolute; top: 70px; right: 70px; width: 220px;
            background: rgba(255, 255, 255, 0.98); border-radius: 16px; padding: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15); z-index: 15; pointer-events: auto;
            max-height: 300px; overflow-y: auto;
        }
        #layer-popover.visible { display: block; animation: fadeIn 0.2s; }
        .layer-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 0; border-bottom: 1px solid #eee; font-size: 14px;
        }
        .layer-row:last-child { border-bottom: none; }
        .layer-label { flex: 1; margin-left: 8px; font-weight: 500; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }

        /* Bottom Controls */
        #bottom-controls {
            position: absolute; bottom: 30px; left: 12px; right: 12px;
            display: flex; flex-direction: column; gap: 12px; z-index: 10;
            pointer-events: none; align-items: flex-end;
        }
        .main-action-btn {
            width: 100%; padding: 16px; border: none; border-radius: 18px;
            font-weight: 700; color: white; font-size: 17px;
            background-color: #8e8e93; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer; pointer-events: auto; transition: background 0.3s;
        }
        .main-action-btn.active { background-color: #34c759; }
        #btn-my-loc { margin-bottom: 5px; margin-left: auto; pointer-events: auto; }

        /* === Settings Panel === */
        #settings-view {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: #f2f2f7; z-index: 20; display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        #settings-view.active { transform: translateX(0); }

        .header {
            background: white; padding: 16px; display: flex; align-items: center;
            border-bottom: 1px solid #e5e5ea;
        }
        .title { font-weight: 800; font-size: 20px; margin-left: 12px; }
        
        .tabs { display: flex; background: white; padding: 0 16px; }
        .tab {
            flex: 1; padding: 14px; border: none; background: none;
            font-weight: 600; color: #8e8e93; border-bottom: 3px solid transparent; cursor: pointer;
        }
        .tab.active { color: #007aff; border-bottom: 3px solid #007aff; }

        .content { flex: 1; overflow-y: auto; padding: 16px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        .card { background: white; border-radius: 14px; padding: 16px; margin-bottom: 20px; }
        .card h3 { margin: 0 0 12px 0; font-size: 13px; color: #8e8e93; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .field { margin-bottom: 16px; }
        .field label { display: block; font-size: 14px; margin-bottom: 6px; font-weight: 600; color: #333; }
        .field input, .field select {
            width: 100%; padding: 12px; border: 1px solid #d1d1d6; border-radius: 10px;
            font-size: 16px; background: #fff; box-sizing: border-box; -webkit-appearance: none;
        }
        .help { font-size: 12px; color: #8e8e93; margin-top: 4px; display: block; }

        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 12px;
            font-weight: 700; font-size: 16px; cursor: pointer; margin-top: 8px;
        }
        .btn-primary { background: #007aff; color: white; }
        .btn-secondary { background: #e5e5ea; color: black; }
        .btn-danger { background: #ff3b30; color: white; }
        .btn-outline { background: white; border: 1px solid #007aff; color: #007aff; }

        /* Layer Manager List */
        .layer-manage-item {
            background: #f9f9f9; padding: 12px; border-radius: 10px; margin-bottom: 8px;
            display: flex; flex-direction: column; gap: 8px; border: 1px solid #eee;
        }
        .layer-header { display: flex; justify-content: space-between; align-items: center; }
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; font-weight: bold; }
        .tag.target { background: #34c759; color: white; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="main-ui">
    <div id="top-bar">
        <div id="status-panel">
            <div class="status-row"><span class="label">Status</span> <span id="st-mode" class="val">Inactive</span></div>
            <div class="status-row"><span class="label">GPS</span> <span id="st-gps" class="val">-</span></div>
            <div class="status-row"><span class="label">Target</span> <span id="st-match" class="val">-</span></div>
            <div class="status-row" style="margin-top:8px;">
                <span style="font-size:11px; display:flex; gap:8px;">
                    <span style="color:#ff3b30">â— 3</span>
                    <span style="color:#ffcc00">â— 2</span>
                    <span style="color:#34c759">â— 1</span>
                    <span style="color:#d1d1d6">â— 0</span>
                </span>
            </div>
        </div>
        
        <div class="right-group">
            <button class="icon-btn" onclick="App.UI.openSettings()">âš™ï¸</button>
            <button class="icon-btn" onclick="App.UI.toggleLayerPopover()">ğŸ—ºï¸</button>
        </div>
    </div>
    
    <div id="layer-popover">
        <div style="font-size:13px; font-weight:bold; color:#8e8e93; margin-bottom:8px;">VISIBLE LAYERS</div>
        <div id="popover-list"></div>
    </div>
    
    <div id="map"></div>

    <div id="bottom-controls">
        <button id="btn-my-loc" class="icon-btn" onclick="App.Map.centerUser()">ğŸ¯</button>
        <button id="btn-survey" class="main-action-btn" onclick="App.Engine.toggleSurvey()">Start Survey</button>
    </div>
</div>

<div id="settings-view">
    <div class="header">
        <button class="icon-btn" style="box-shadow:none; width:36px; height:36px;" onclick="App.UI.closeSettings()">â®</button>
        <span class="title">Settings</span>
    </div>
    
    <div class="tabs">
        <button class="tab active" onclick="App.UI.switchTab('tab-layers')">ë ˆì´ì–´ & ë°ì´í„°</button>
        <button class="tab" onclick="App.UI.switchTab('tab-algo')">ì•Œê³ ë¦¬ì¦˜</button>
        <button class="tab" onclick="App.UI.switchTab('tab-system')">ì‹œìŠ¤í…œ</button>
    </div>
    
    <div class="content">
        <div id="tab-layers" class="tab-pane active">
            <div class="card">
                <h3>ìƒˆ ë ˆì´ì–´ ì¶”ê°€</h3>
                <div class="field">
                    <label>ìœ í˜• ì„ íƒ</label>
                    <select id="add-type" onchange="App.UI.toggleAddForm()">
                        <option value="geojson_file">ë¡œì»¬ GeoJSON íŒŒì¼ (Line/Point)</option>
                        <option value="geojson_url">ì›¹ GeoJSON URL (WFS)</option>
                        <option value="raster">ë°°ê²½ì§€ë„ URL (XYZ/TMS)</option>
                    </select>
                </div>
                
                <div id="form-url" class="field">
                    <label>URL ì£¼ì†Œ / íŒŒì¼ ì„ íƒ</label>
                    <input type="text" id="add-url" placeholder="https://...">
                    <input type="file" id="add-file" accept=".geojson,.json" style="display:none">
                    <button id="btn-file-sel" class="btn btn-secondary" onclick="document.getElementById('add-file').click()">ğŸ“‚ íŒŒì¼ ì„ íƒ</button>
                </div>
                
                <div class="field">
                    <label>ë ˆì´ì–´ ì´ë¦„</label>
                    <input type="text" id="add-name" placeholder="ì˜ˆ: Link Data, VWorld">
                </div>
                
                <button class="btn btn-primary" onclick="App.Layers.addNewLayerFromUI()">ì¶”ê°€í•˜ê¸°</button>
            </div>

            <div class="card">
                <h3>ë“±ë¡ëœ ë ˆì´ì–´ ëª©ë¡</h3>
                <div id="manage-list"></div>
                <small class="help">* 'Target' ë²„íŠ¼ì„ ëˆŒëŸ¬ ë§¤ì¹­ ëŒ€ìƒì„ ì§€ì •í•˜ì„¸ìš”.</small>
            </div>
        </div>

        <div id="tab-algo" class="tab-pane">
            <div class="card">
                <h3>ìš´ì˜ ëª¨ë“œ</h3>
                <div class="field">
                    <select id="cfg-mode">
                        <option value="dec">ê°ì†Œ (Count Down)</option>
                        <option value="inc">ì¦ê°€ (Count Up)</option>
                    </select>
                </div>
            </div>
            <div class="card">
                <h3>ë§¤ì¹­ íŒŒë¼ë¯¸í„°</h3>
                <div class="field">
                    <label>ë³´ê°„ ê°„ê²© (m)</label>
                    <input type="number" id="cfg-interp" step="0.05">
                </div>
                <div class="field">
                    <label>íƒìƒ‰ ë°˜ê²½ (m)</label>
                    <input type="number" id="cfg-dist">
                </div>
                <div class="field">
                    <label>Overlap (0.1~1.0)</label>
                    <input type="number" id="cfg-overlap" step="0.05" max="1.0">
                </div>
            </div>
            <div class="card">
                <h3>ë°ì´í„° ì»¬ëŸ¼</h3>
                <div class="field">
                    <label>Target Field (ì†ì„±ëª…)</label>
                    <input type="text" id="cfg-field">
                </div>
                <div class="field">
                    <label>Default Value</label>
                    <input type="number" id="cfg-defval">
                </div>
                <button class="btn btn-outline" onclick="App.Layers.resetTargetValues()">í˜„ì¬ ê°’ ì¼ê´„ ì´ˆê¸°í™”</button>
            </div>
            <button class="btn btn-primary" onclick="App.Config.saveFromUI()">ì„¤ì • ì €ì¥</button>
        </div>

        <div id="tab-system" class="tab-pane">
            <div class="card">
                <h3>ì‹¤ì‹œê°„ ì „ì†¡ (WebSocket)</h3>
                <div class="field">
                    <label>Server URL</label>
                    <input type="text" id="cfg-ws" placeholder="wss://...">
                </div>
                <button id="btn-ws" class="btn btn-secondary" onclick="App.Engine.toggleWS()">ì—°ê²° ì‹œì‘</button>
            </div>
            <div class="card">
                <h3>ë°ì´í„° ê´€ë¦¬</h3>
                <button class="btn btn-secondary" onclick="App.Engine.exportLog()">GPS ë¡œê·¸ ë‹¤ìš´ë¡œë“œ (GeoJSON)</button>
                <button class="btn btn-danger" onclick="App.Config.clearAll()">ì•± ì´ˆê¸°í™” (ëª¨ë“  ë°ì´í„° ì‚­ì œ)</button>
            </div>
        </div>
    </div>
</div>

<script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
<script src='https://unpkg.com/@turf/turf@6.5.0/turf.min.js'></script>

<script>
/**
 * Route Manager V1
 * Solid Architecture: App = { Config, State, Layers, Map, Engine, UI }
 */
const App = {
    // 1. Configuration & Persistence
    Config: {
        data: {
            interpStep: 0.25, // m
            searchRadius: 12.5, // m
            overlapRatio: 0.9,
            bufferRadius: 1.0, // m
            mode: 'dec',
            targetField: 'target_cnt',
            defaultValue: 1,
            wsUrl: 'wss://echo.websocket.org'
        },
        init() {
            const saved = localStorage.getItem('RM_Config_V1');
            if (saved) this.data = { ...this.data, ...JSON.parse(saved) };
        },
        save() {
            localStorage.setItem('RM_Config_V1', JSON.stringify(this.data));
        },
        saveFromUI() {
            this.data.interpStep = parseFloat(document.getElementById('cfg-interp').value);
            this.data.searchRadius = parseFloat(document.getElementById('cfg-dist').value);
            this.data.overlapRatio = parseFloat(document.getElementById('cfg-overlap').value);
            this.data.mode = document.getElementById('cfg-mode').value;
            this.data.targetField = document.getElementById('cfg-field').value;
            this.data.defaultValue = parseInt(document.getElementById('cfg-defval').value);
            this.data.wsUrl = document.getElementById('cfg-ws').value;
            this.save();
            
            // Re-render target layer if field changed
            if (App.Layers.targetId) App.Layers.applyTargetStyle(App.Layers.targetId);
            
            alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            App.UI.closeSettings();
        },
        clearAll() {
            if(confirm("ëª¨ë“  ì„¤ì •ê³¼ ë ˆì´ì–´ ì •ë³´ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.clear();
                location.reload();
            }
        }
    },

    // 2. Global State
    State: {
        isSurveying: false,
        lastGps: null, // {lng, lat, speed, heading, acc}
        wsConnected: false,
        gpsLog: [],
        traceMemory: {}, // {fid: [coords]}
        visitHistory: {}, // {fid: ts}
    },

    // 3. Layer Manager
    Layers: {
        list: [], // {id, type, name, url, visible, isTarget, data(optional)}
        targetId: null,

        init() {
            const saved = localStorage.getItem('RM_Layers_V1');
            if (saved) this.list = JSON.parse(saved);
            else {
                // Default Base Layer
                this.addLayer({
                    id: 'osm-base', type: 'raster', name: 'OpenStreetMap', visible: true,
                    url: 'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'
                });
            }
        },
        
        save() {
            // Save metadata only (not huge geojson content if file)
            // For V1, local files are NOT persisted content-wise, only config.
            // URL based layers are persisted.
            const toSave = this.list.map(l => {
                const { data, ...meta } = l; // Exclude raw data
                return meta;
            });
            localStorage.setItem('RM_Layers_V1', JSON.stringify(toSave));
        },

        addLayer(layerObj) {
            this.list.push(layerObj);
            this.addToMap(layerObj);
            this.save();
            App.UI.renderLayerLists();
        },

        removeLayer(id) {
            if (id === 'osm-base') return alert("ê¸°ë³¸ ì§€ë„ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            if (App.Map.instance.getLayer(id)) App.Map.instance.removeLayer(id);
            if (App.Map.instance.getSource(id)) App.Map.instance.removeSource(id);
            
            // If removing target, clear target
            if (this.targetId === id) {
                if (App.Map.instance.getLayer('target-viz')) App.Map.instance.removeLayer('target-viz');
                this.targetId = null;
            }

            this.list = this.list.filter(l => l.id !== id);
            this.save();
            App.UI.renderLayerLists();
        },

        setTarget(id) {
            const layer = this.list.find(l => l.id === id);
            if (!layer || layer.type !== 'geojson') return;

            // Reset previous
            this.list.forEach(l => l.isTarget = false);
            layer.isTarget = true;
            this.targetId = id;
            
            // Apply Target Logic (Smart Init & Viz)
            if (layer.data) {
                this.ensureFields(layer.data);
                App.Map.instance.getSource(id).setData(layer.data); // Update source
            }
            this.applyTargetStyle(id);
            
            this.save();
            App.UI.renderLayerLists();
            alert(`[${layer.name}] ë ˆì´ì–´ê°€ ë§¤ì¹­ ëŒ€ìƒìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        },

        ensureFields(geojson) {
            let modified = false;
            const field = App.Config.data.targetField;
            const def = App.Config.data.defaultValue;
            
            if (geojson && geojson.features) {
                geojson.features.forEach(f => {
                    if (f.properties[field] === undefined || f.properties[field] === null) {
                        f.properties[field] = def;
                        modified = true;
                    }
                });
            }
            if (modified) console.log("Fields initialized.");
        },

        resetTargetValues() {
            if (!this.targetId) return alert("ì„¤ì •ëœ Target ë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            const layer = this.list.find(l => l.id === this.targetId);
            if (!layer || !layer.data) return;

            if (confirm("ëª¨ë“  ê°’ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const field = App.Config.data.targetField;
                const def = App.Config.data.defaultValue;
                layer.data.features.forEach(f => f.properties[field] = def);
                App.Map.instance.getSource(this.targetId).setData(layer.data);
                alert("ì´ˆê¸°í™” ì™„ë£Œ");
            }
        },

        addToMap(l) {
            const map = App.Map.instance;
            if (map.getSource(l.id)) return; // Already exists

            if (l.type === 'raster') {
                map.addSource(l.id, { type: 'raster', tiles: [l.url], tileSize: 256 });
                // Insert raster at bottom but above base
                const before = (l.id === 'osm-base') ? undefined : 'target-viz'; 
                // Actually simple logic: always add. Reordering is complex. 
                // Just add to bottom.
                map.addLayer({
                    id: l.id, type: 'raster', source: l.id,
                    layout: { visibility: l.visible ? 'visible' : 'none' }
                }, 'target-bg'); // Put below vectors
            } 
            else if (l.type === 'geojson') {
                // If data is missing (reloaded page), try fetch if url exists
                if (!l.data && l.url) {
                    fetch(l.url).then(r => r.json()).then(json => {
                        l.data = json;
                        this.addToMap(l); // Retry
                    }).catch(e => console.error(e));
                    return;
                }
                if (!l.data) return; // No data yet

                map.addSource(l.id, { type: 'geojson', data: l.data });
                
                // 1. Background Line (Gray)
                map.addLayer({
                    id: l.id, type: 'line', source: l.id,
                    layout: { 'line-cap': 'round', 'line-join': 'round', visibility: l.visible ? 'visible' : 'none' },
                    paint: { 'line-width': 6, 'line-color': '#888', 'line-opacity': 0.4 }
                });

                if (l.isTarget) {
                    this.targetId = l.id;
                    this.ensureFields(l.data);
                    this.applyTargetStyle(l.id);
                }
            }
        },

        applyTargetStyle(sourceId) {
            const map = App.Map.instance;
            // Remove old viz if exists
            if (map.getLayer('target-viz')) map.removeLayer('target-viz');

            // Add Viz Layer (On Top)
            const field = App.Config.data.targetField;
            map.addLayer({
                id: 'target-viz', type: 'line', source: sourceId,
                layout: { 'line-cap': 'round', 'line-join': 'round' },
                paint: {
                    'line-width': 5,
                    'line-color': [
                        'match', ['get', field],
                        1, '#34c759', // Green
                        2, '#ffcc00', // Orange
                        3, '#ff3b30', // Red
                        '#007aff'     // Default Blue
                    ],
                    'line-opacity': [
                        'case', ['>', ['get', field], 0], 0.6,
                        0.0 // Hide if 0
                    ]
                }
            });
        },

        addNewLayerFromUI() {
            const type = document.getElementById('add-type').value;
            const name = document.getElementById('add-name').value;
            if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

            const newId = 'layer-' + Date.now();
            let layerObj = { id: newId, name: name, visible: true, isTarget: false };

            if (type === 'raster') {
                const url = document.getElementById('add-url').value;
                if (!url) return alert("URLì„ ì…ë ¥í•˜ì„¸ìš”.");
                layerObj.type = 'raster';
                layerObj.url = url;
                this.addLayer(layerObj);
            } 
            else if (type === 'geojson_url') {
                const url = document.getElementById('add-url').value;
                if (!url) return alert("URLì„ ì…ë ¥í•˜ì„¸ìš”.");
                layerObj.type = 'geojson';
                layerObj.url = url;
                this.addLayer(layerObj);
            }
            else if (type === 'geojson_file') {
                const fileInput = document.getElementById('add-file');
                const file = fileInput.files[0];
                if (!file) return alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        layerObj.type = 'geojson';
                        layerObj.data = json; // Keep in memory
                        this.addLayer(layerObj);
                        
                        // Auto Zoom
                        const bbox = turf.bbox(json);
                        App.Map.instance.fitBounds(bbox, {padding: 50});
                        
                        // Auto Set Target if it's the first vector
                        if (!this.targetId) this.setTarget(newId);
                        
                    } catch(err) { alert("íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨"); }
                };
                reader.readAsText(file);
            }
            
            // Clear Inputs
            document.getElementById('add-name').value = '';
            document.getElementById('add-url').value = '';
            document.getElementById('add-file').value = '';
        }
    },

    // 4. Map Control
    Map: {
        instance: null,
        init() {
            this.instance = new maplibregl.Map({
                container: 'map',
                style: { version: 8, sources: {}, layers: [] },
                center: [126.9778, 37.5663], zoom: 17, pitch: 0
            });
            
            this.instance.on('load', () => {
                // Add User Marker Source
                this.instance.addSource('user_pos', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
                this.instance.addLayer({
                    id: 'user-marker', type: 'circle', source: 'user_pos',
                    paint: { 'circle-radius': 8, 'circle-color': '#8e8e93', 'circle-stroke-width': 2, 'circle-stroke-color': '#fff' }
                });
                
                App.Layers.init();
                // Restore layers
                App.Layers.list.forEach(l => App.Layers.addToMap(l));
                
                App.Engine.startGps();
            });
        },
        
        updateMarker(pt, active) {
            const color = active ? '#34c759' : '#8e8e93';
            this.instance.setPaintProperty('user-marker', 'circle-color', color);
            this.instance.getSource('user_pos').setData({
                type: 'FeatureCollection',
                features: [{ type: 'Feature', geometry: { type: 'Point', coordinates: pt } }]
            });
        },
        
        centerUser() {
            if (App.State.lastGps) {
                this.instance.flyTo({ center: [App.State.lastGps.lng, App.State.lastGps.lat], zoom: 18 });
            } else alert("GPS ì‹ í˜¸ ëŒ€ê¸° ì¤‘...");
        }
    },

    // 5. Logic Engine
    Engine: {
        watchId: null,
        wsSocket: null,
        
        startGps() {
            if (!navigator.geolocation) return;
            this.watchId = navigator.geolocation.watchPosition(
                pos => {
                    const { longitude, latitude, accuracy, speed, heading } = pos.coords;
                    App.State.lastGps = { lng: longitude, lat: latitude, speed: speed||0, heading: heading||0 };
                    
                    // UI Update
                    document.getElementById('st-gps').innerText = `Â±${Math.round(accuracy)}m`;
                    
                    // Update Marker
                    App.Map.updateMarker([longitude, latitude], App.State.isSurveying);
                    
                    // Logic
                    if (App.State.isSurveying) {
                        this.processMatching([longitude, latitude]);
                        
                        // Dynamic Zoom
                        const speedKmh = (speed||0) * 3.6;
                        if (speedKmh > 20) App.Map.instance.easeTo({zoom: 16});
                    }
                },
                err => console.error(err),
                { enableHighAccuracy: true, timeout: 5000 }
            );
            
            // WS Loop (1s)
            setInterval(() => this.sendWs(), 1000);
        },

        toggleSurvey() {
            App.State.isSurveying = !App.State.isSurveying;
            App.UI.updateSurveyBtn();
        },

        processMatching(pt) {
            const layerId = App.Layers.targetId;
            if (!layerId) return; // No target
            
            const layer = App.Layers.list.find(l => l.id === layerId);
            if (!layer || !layer.data) return;

            // Log
            App.State.gpsLog.push({
                type: "Feature", geometry: { type: "Point", coordinates: pt },
                properties: { time: new Date().toISOString() }
            });

            // Match
            const cfg = App.Config.data;
            const ptGeo = turf.point(pt);
            let bestId = null, minDist = Infinity;

            // Simple loop match (Use RBush for heavy data)
            layer.data.features.forEach(f => {
                const snapped = turf.nearestPointOnLine(f, ptGeo);
                const dist = turf.distance(ptGeo, snapped, {units: 'kilometers'}) * 1000; // m
                if (dist < cfg.searchRadius && dist < minDist) {
                    minDist = dist; 
                    bestId = f.properties.id || f.id;
                }
            });

            document.getElementById('st-match').innerText = bestId ? `ID: ${bestId}` : "-";
            if (bestId) this.updateTrace(layerId, bestId, pt);
        },

        updateTrace(layerId, linkId, pt) {
            const key = `${layerId}-${linkId}`;
            if (!App.State.traceMemory[key]) App.State.traceMemory[key] = [];
            
            const mem = App.State.traceMemory[key];
            if (mem.length > 200) mem.shift();
            mem.push(pt);

            if (mem.length < 2) return;

            // Overlap Check
            try {
                const cfg = App.Config.data;
                const line = turf.lineString(mem);
                const simple = turf.simplify(line, {tolerance: 0.00001});
                const tBuf = turf.buffer(simple, cfg.bufferRadius/1000, {units:'kilometers'});
                
                const layer = App.Layers.list.find(l => l.id === layerId);
                const lFeat = layer.data.features.find(f => (f.properties.id == linkId || f.id == linkId));
                const lBuf = turf.buffer(lFeat, cfg.bufferRadius/1000, {units:'kilometers'});
                
                const inter = turf.intersect(tBuf, lBuf);
                if (inter) {
                    const ratio = turf.area(inter) / turf.area(lBuf);
                    if (ratio >= cfg.overlapRatio) this.handlePass(layer, lFeat);
                }
            } catch(e) {}
        },

        handlePass(layer, feature) {
            const key = `${layer.id}-${feature.properties.id}`;
            const now = Date.now();
            if (App.State.visitHistory[key] && (now - App.State.visitHistory[key]) < 5000) return;
            App.State.visitHistory[key] = now;

            // Update Value
            const cfg = App.Config.data;
            let val = feature.properties[cfg.targetField] || 0;
            if (cfg.mode === 'dec') { val--; if(val<0) val=0; }
            else val++;
            
            feature.properties[cfg.targetField] = val;
            
            // Refresh Map
            App.Map.instance.getSource(layer.id).setData(layer.data);
        },

        toggleWS() {
            if (App.State.wsConnected) {
                App.State.wsSocket.close();
                App.State.wsConnected = false;
                document.getElementById('btn-ws').innerText = "ì—°ê²° ì‹œì‘";
                document.getElementById('btn-ws').className = "btn btn-secondary";
            } else {
                const url = App.Config.data.wsUrl;
                try {
                    App.State.wsSocket = new WebSocket(url);
                    App.State.wsSocket.onopen = () => {
                        App.State.wsConnected = true;
                        document.getElementById('btn-ws').innerText = "ì—°ê²° ì¢…ë£Œ";
                        document.getElementById('btn-ws').className = "btn btn-primary";
                        alert("WS ì—°ê²°ë¨");
                    };
                    App.State.wsSocket.onclose = () => { App.State.wsConnected = false; };
                } catch(e) { alert("ì—°ê²° ì‹¤íŒ¨"); }
            }
        },

        sendWs() {
            if (App.State.wsConnected && App.State.lastGps) {
                const payload = { ...App.State.lastGps, surveying: App.State.isSurveying, ts: Date.now() };
                App.State.wsSocket.send(JSON.stringify(payload));
            }
        },

        exportLog() {
            if (App.State.gpsLog.length === 0) return alert("ë¡œê·¸ ì—†ìŒ");
            const gj = { type: "FeatureCollection", features: App.State.gpsLog };
            const blob = new Blob([JSON.stringify(gj)], {type:"application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `gps_${Date.now()}.geojson`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
    },

    // 6. UI Manager
    UI: {
        openSettings() { 
            document.getElementById('settings-view').classList.add('active');
            // Sync UI with Config
            const d = App.Config.data;
            document.getElementById('cfg-interp').value = d.interpStep * 1000;
            document.getElementById('cfg-dist').value = d.searchRadius * 1000;
            document.getElementById('cfg-overlap').value = d.overlapRatio;
            document.getElementById('cfg-mode').value = d.mode;
            document.getElementById('cfg-field').value = d.targetField;
            document.getElementById('cfg-defval').value = d.defaultValue;
            document.getElementById('cfg-ws').value = d.wsUrl;
        },
        closeSettings() { document.getElementById('settings-view').classList.remove('active'); },
        
        switchTab(id) {
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(id).classList.add('active');
        },

        toggleLayerPopover() {
            const el = document.getElementById('layer-popover');
            el.classList.toggle('visible');
            this.renderLayerLists();
        },

        toggleAddForm() {
            const type = document.getElementById('add-type').value;
            const formUrl = document.getElementById('form-url');
            if (type === 'geojson_file') {
                formUrl.innerHTML = '<input type="file" id="add-file" accept=".geojson,.json" class="btn btn-secondary">';
            } else {
                formUrl.innerHTML = '<input type="text" id="add-url" placeholder="URL ì…ë ¥...">';
            }
        },

        updateSurveyBtn() {
            const btn = document.getElementById('btn-survey');
            const st = document.getElementById('st-mode');
            if (App.State.isSurveying) {
                btn.innerText = "Stop Survey";
                btn.classList.add('active');
                st.innerText = "Active";
                st.classList.add('active');
            } else {
                btn.innerText = "Start Survey";
                btn.classList.remove('active');
                st.innerText = "Inactive";
                st.classList.remove('active');
            }
        },

        renderLayerLists() {
            // 1. Manage List (Settings)
            const mList = document.getElementById('manage-list');
            mList.innerHTML = '';
            
            App.Layers.list.forEach(l => {
                if (l.id === 'osm-base') return;
                const isTarget = l.id === App.Layers.targetId;
                mList.innerHTML += `
                <div class="layer-manage-item">
                    <div class="layer-header">
                        <span style="font-weight:600;">${l.name}</span>
                        <div>
                            ${isTarget ? '<span class="tag target">TARGET</span>' : ''}
                            <span class="tag">${l.type}</span>
                        </div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        ${l.type === 'geojson' ? 
                          `<button class="btn btn-primary" style="margin:0; padding:8px; font-size:12px; flex:2;" onclick="App.Layers.setTarget('${l.id}')">Set Target</button>` 
                          : ''}
                        <button class="btn btn-danger" style="margin:0; padding:8px; font-size:12px; flex:1;" onclick="App.Layers.removeLayer('${l.id}')">ì‚­ì œ</button>
                    </div>
                </div>`;
            });

            // 2. Popover List (Main)
            const pList = document.getElementById('popover-list');
            pList.innerHTML = '';
            
            App.Layers.list.forEach(l => {
                pList.innerHTML += `
                <div class="layer-row">
                    <span class="layer-label">${l.name} ${l.id === App.Layers.targetId ? ' (Target)':''}</span>
                    <input type="checkbox" ${l.visible ? 'checked' : ''} onchange="App.UI.toggleVis('${l.id}', this.checked)">
                </div>`;
            });
        },

        toggleVis(id, visible) {
            const layer = App.Layers.list.find(l => l.id === id);
            if (layer) {
                layer.visible = visible;
                const map = App.Map.instance;
                if (map.getLayer(id)) map.setLayoutProperty(id, 'visibility', visible ? 'visible' : 'none');
                if (id === App.Layers.targetId && map.getLayer('target-viz')) {
                    map.setLayoutProperty('target-viz', 'visibility', visible ? 'visible' : 'none');
                }
                App.Layers.save();
            }
        }
    }
};

// Start App
App.Config.init();
App.Map.init();

</script>
</body>
</html>